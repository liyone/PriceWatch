name: Price Scraping with Virtual Display

on:
  schedule:
    # Run twice daily at 8 AM and 8 PM UTC
    - cron: '0 8,20 * * *'
  workflow_dispatch: # Allow manual triggers
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/**'

env:
  NODE_VERSION: '20'

jobs:
  scrape-with-real-browser:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci
        # Install real browsers for virtual display
        npx playwright install chromium firefox
        sudo apt-get update
        sudo apt-get install -y xvfb

    - name: Build project
      run: npm run build

    - name: Setup virtual display
      run: |
        # Start Xvfb (X Virtual Framebuffer) for real browser
        export DISPLAY=:99
        Xvfb :99 -ac -screen 0 1920x1080x24 &
        sleep 3
        echo "DISPLAY=:99" >> $GITHUB_ENV

    - name: Run scraper with real browser
      env:
        DISPLAY: :99
        GITHUB_ACTIONS: true
        REAL_BROWSER_MODE: true
        # Optional: Discord webhook for alerts
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        echo "🌐 Starting real browser scraping on virtual display"
        echo "Display: $DISPLAY"

        # Run with real browser mode
        npm run start:real-browser || npm run start

        echo "✅ Scraping completed"

    - name: Check for data changes
      id: changes
      run: |
        if git diff --quiet data/; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No price changes detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Price changes detected!"
          git diff --stat data/
        fi

    - name: Commit and push changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/

        # Create commit with timestamp
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
        git commit -m "🔄 Automated scrape: CSV data update ($TIMESTAMP)"

        # Push changes
        git push

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scraping-results
        path: |
          data/
          *.png
          *.log
        retention-days: 7

    - name: Summary
      if: always()
      run: |
        echo "## 🎯 Scraping Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Display Mode**: Virtual (Xvfb)" >> $GITHUB_STEP_SUMMARY
        echo "- **Browser**: Real Chromium/Firefox" >> $GITHUB_STEP_SUMMARY
        echo "- **Changes**: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY

        if [ -f "data/deals_$(date +%Y%m%d).csv" ]; then
          echo "- **Products scraped**: $(tail -n +2 data/deals_$(date +%Y%m%d).csv | wc -l)" >> $GITHUB_STEP_SUMMARY
        fi